import os
import importlib.util
import json
from flask import Flask, request, jsonify
import google.generativeai as genai
from google.genai.types import Content, Part
from flask import current_app as app
import traceback
from flask import request
import pymysql
from pymysql.cursors import DictCursor

# Google GenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” (Gemini API ì‚¬ìš©)
client = genai.configure(api_key="genai_app_key")

# ì „ì—­ client ê°ì²´
model = None
conversations = {}

def ensure_model():
    global model, client
    try:
        if model is None:
            model = genai.GenerativeModel("gemini-2.0-flash-lite")
        if client is None:
            client = model.start_chat()
    except Exception as e:
        print("Gemini ëª¨ë¸ ì´ˆê¸°í™” ì‹¤íŒ¨:", e)
        model = None
        client = None

# Flask ì•± ìƒì„±
app = Flask(__name__)

# âœ… ë”•ì…”ë„ˆë¦¬ë¡œ ì„¤ì •ë§Œ ì €ì¥í•´ë†“ê¸° (Connection ì•„ë‹˜!)
DB_CONFIG = {
    'host': '127.0.0.1',
    'user': 'root',
    'password': '',
    'database': 'THE_UNLOCK',
    'charset': 'utf8mb4',
    'cursorclass': DictCursor
}

LAW_KNOWLEDGE = {}

def load_law_knowledge():
    global LAW_KNOWLEDGE
    try:
        # âœ… ë”•ì…”ë„ˆë¦¬ë¥¼ ì–¸íŒ¨í‚¹í•´ì„œ ì‹¤ì œ ì—°ê²°!
        conn = pymysql.connect(**DB_CONFIG)
        with conn.cursor() as cursor:
            sql = "SELECT title, content FROM pdfFile WHERE title IN (%s, %s)"
            cursor.execute(sql, ('í˜•ë²•', 'í˜•ì‚¬ì†Œì†¡ë²•'))
            rows = cursor.fetchall()
            for row in rows:
                LAW_KNOWLEDGE[row['title']] = row['content']
        conn.close()
        print("ë²•ë¥  ì§€ì‹ ë¡œë“œ ì™„ë£Œ")
    except Exception as e:
        print("ë²•ë¥  ì§€ì‹ ë¡œë“œ ì‹¤íŒ¨:", e)

load_law_knowledge()

def find_related_laws(case_facts, law_knowledge):
    """
    ì‚¬ê±´ ê°œìš”(case_facts)ì— í¬í•¨ëœ ë‹¨ì–´ë“¤ê³¼ ë²•ì¡°ë¬¸ ë‚´ìš©ì„ ë¹„êµí•˜ì—¬
    ê´€ë ¨ì´ ìˆëŠ” ì¡°ë¬¸ í‚¤ë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ë°˜í™˜í•œë‹¤.
    ì•„ì£¼ ë‹¨ìˆœíˆ ë²•ì¡°ë¬¸ ë‚´ìš© ì¤‘ í•œë‘ ë‹¨ì–´ë¼ë„ í¬í•¨ë¼ ìˆìœ¼ë©´ ê´€ë ¨ ìˆë‹¤ê³  íŒë‹¨.
    """
    related_laws = []
    for law_title, law_text in law_knowledge.items():
        # ë²•ì¡°ë¬¸ ë¬¸ì¥ ë‹¨ì–´ë¡œ ë‚˜ëˆ„ê¸° (ê°„ë‹¨íˆ ë„ì–´ì“°ê¸° ê¸°ì¤€)
        words = law_text.split()
        # ì‚¬ê±´ ê°œìš”ì— ë²•ì¡°ë¬¸ ë‹¨ì–´ ì¤‘ ì¼ë¶€ë¼ë„ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ê´€ë ¨ ì¡°ë¬¸ìœ¼ë¡œ ê°„ì£¼
        if any(word in case_facts for word in words):
            related_laws.append(law_title)
    return related_laws

# ì„¸ì…˜ë³„ ëŒ€í™” ì €ì¥ì†Œ
conversations = {}

# ì¬íŒ ë‹¨ê³„ë³„ ë°œì–¸ ìˆœì„œ ì •ì˜
PHASE_SPEAK_ORDER = {
    "ì„œë¡ ": ["íŒì‚¬", "ê²€ì‚¬", "ë³€í˜¸ì‚¬"],
    "ì¦ê±° ì œì¶œ": ["íŒì‚¬", "ê²€ì‚¬", "ë³€í˜¸ì‚¬"],
    "ì¦ì¸ ì‹¬ë¬¸": ["íŒì‚¬", "ê²€ì‚¬", "ë³€í˜¸ì‚¬"],
    "ìµœì¢…ë³€ë¡ ": ["íŒì‚¬", "ê²€ì‚¬", "ë³€í˜¸ì‚¬"],
    "í‰ê²°": ["íŒì‚¬"]
}

# /data í´ë”ì— ìˆëŠ” ì‚¬ê±´ ì •ë³´ë¥¼ ë‹´ì€ .py íŒŒì¼ë“¤ì„ ë™ì ìœ¼ë¡œ ë¶ˆëŸ¬ì˜´
def load_case_database():
    CASE_DATABASE = {}
    data_dir = os.path.join(os.path.dirname(__file__), "data")
    
    for filename in os.listdir(data_dir):
        if filename.endswith(".py"):
            filepath = os.path.join(data_dir, filename)
            spec = importlib.util.spec_from_file_location("module.name", filepath)
            module = importlib.util.module_from_spec(spec)
            spec.loader.exec_module(module)

            if hasattr(module, "cases"):
                for case in module.cases:
                    case_name = case.get("caseName")
                    if case_name:
                        CASE_DATABASE[case_name] = case
            else:
                print(f"[ê²½ê³ ] {filename} ì— 'cases' ë³€ìˆ˜ ì—†ìŒ")

    print("í˜„ì¬ ë¡œë“œëœ ì‚¬ê±´ ëª©ë¡:", list(CASE_DATABASE.keys()))
    return CASE_DATABASE

# ì‚¬ê±´ ì •ë³´ë¥¼ ì €ì¥í•  ì „ì—­ ë”•ì…”ë„ˆë¦¬
CASE_DATABASE = load_case_database()

# ì—­í• ê³¼ ì¬íŒ ë‹¨ê³„ì— ë”°ë¥¸ í”„ë¡¬í”„íŠ¸ ìƒì„±
def build_prompt_for_role(role, phase, case_info):
    templates = {
        ("íŒì‚¬", "ì„œë¡ "): "ì¬íŒ ê°œì‹œ ë° ì ˆì°¨ ì•ˆë‚´ë¥¼ í•´ ì£¼ì„¸ìš”.",
        ("ê²€ì‚¬", "ì„œë¡ "): "ì‚¬ê±´ ê°œìš” ë° ê³µì†Œ ì‚¬ì‹¤ì„ ì§„ìˆ í•˜ëŠ” ì˜ˆì‹œë¥¼ ë³´ì—¬ ì£¼ì„¸ìš”.",
        ("ë³€í˜¸ì‚¬", "ì„œë¡ "): "ë³€ë¡  ìš”ì§€ì™€ ë¬´ì£„ ì£¼ì¥ì„ ê°„ëµí•˜ê²Œ ì„¤ëª…í•˜ëŠ” ì˜ˆì‹œë¥¼ ë³´ì—¬ ì£¼ì„¸ìš”.",
        ("íŒì‚¬", "ì¦ì¸ ì‹¬ë¬¸ ì‹œì‘"): "ì¦ì¸ì‹ ë¬¸ ì ˆì°¨ì™€ ë°œì–¸ ì•ˆë‚´ ì˜ˆì‹œë¥¼ ë³´ì—¬ ì£¼ì„¸ìš”.",
        ("ê²€ì‚¬", "ì¦ì¸ ì‹¬ë¬¸"): "ì¦ì¸ì—ê²Œ ì§ˆë¬¸í•˜ëŠ” ì˜ˆì‹œë¥¼ ë³´ì—¬ ì£¼ì„¸ìš”.",
        ("ë³€í˜¸ì‚¬", "ì¦ì¸ ì‹¬ë¬¸"): "ì¦ì¸ì—ê²Œ ë°˜ëŒ€ì‹ ë¬¸í•˜ëŠ” ì˜ˆì‹œë¥¼ ë³´ì—¬ ì£¼ì„¸ìš”.",
        ("íŒì‚¬", "ìµœì¢… ì˜ê²¬ ìš”ì²­"): "ìµœì¢… ì˜ê²¬ ìš”ì²­ ë°œì–¸ ì˜ˆì‹œë¥¼ ë³´ì—¬ ì£¼ì„¸ìš”.",
        ("ê²€ì‚¬", "ìµœì¢… ë³€ë¡ "): "ìµœì¢… ë³€ë¡  ìš”ì§€ ì˜ˆì‹œë¥¼ ë³´ì—¬ ì£¼ì„¸ìš”.",
        ("ë³€í˜¸ì‚¬", "ìµœì¢… ë³€ë¡ "): "ìµœì¢… ë³€ë¡  ìš”ì§€ ì˜ˆì‹œë¥¼ ë³´ì—¬ ì£¼ì„¸ìš”.",
        ("íŒì‚¬", "íŒê²° ì„ ê³ "): "íŒê²° ì„ ê³ ë¬¸ ì˜ˆì‹œë¥¼ ë³´ì—¬ ì£¼ì„¸ìš”.",
    }
    key = (role, phase)
    prompt = templates.get(key, "ì—­í• ê³¼ ë‹¨ê³„ì— ë§ëŠ” ë°œì–¸ ì˜ˆì‹œë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”.")
    return f"ì‚¬ê±´ ì •ë³´:\n{case_info}\n\nì—­í• : {role}\në‹¨ê³„: {phase}\n\n{prompt}"

# ì´ˆê¸° ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ ì—­í• , ì‚¬ê±´ ì •ë³´, ë°œì–¸ ìˆœì„œ ë“±ì„ ì•ˆë‚´
def build_initial_prompt(case_name, current_phase, speak_order, user_role, case_facts, is_first_time=True):
    ai_roles = [role for role in speak_order if role != user_role]
    base_prompt = f"""
ë„ˆëŠ” '{case_name}' ì‚¬ê±´ì˜ ë²•ì • ëª¨ì˜ì¬íŒ ì‹œë®¬ë ˆì´í„° AIì•¼.
í˜„ì¬ ì¬íŒ ë‹¨ê³„ëŠ” '{current_phase}'ì´ê³ , ë°œì–¸ ìˆœì„œëŠ” {speak_order}ì•¼.
ì‚¬ìš©ìëŠ” '{user_role}' ì—­í• ì„ ë§¡ê³  ìˆê³ , ë„ˆëŠ” ë‚˜ë¨¸ì§€ ì—­í• ì¸ {ai_roles} ì—­í• ì„ ë§¡ì•„ì•¼ í•´.

ê° ì—­í• ë³„ ê·œì¹™:
- íŒì‚¬: ì ˆì°¨ ì•ˆë‚´, ì¤‘ì¬, ë°œì–¸ ìœ ë„
- ê²€ì‚¬: ìœ ì£„ ì…ì¦ (ì¦ê±°, ì •í™© ì¤‘ì‹¬)
- ë³€í˜¸ì‚¬: ë¬´ì£„ ë˜ëŠ” ê°í˜• ì£¼ì¥ (ì•Œë¦¬ë°”ì´, ì¦ê±° ë¶ˆì¶©ë¶„ ë“±)

ì‚¬ê±´ ì •ë³´:
{case_facts}

AIëŠ” ë°˜ë“œì‹œ ë°œì–¸ ìˆœì„œì— ë”°ë¼ {ai_roles} ì—­í• ë§Œ ìˆ˜í–‰í•´ì•¼ í•´.
í•œ ë²ˆì— í•˜ë‚˜ì˜ ì—­í• ë§Œ ë§í•˜ë„ë¡ í•´.
ì´ë²ˆì—ëŠ” AIê°€ ë§¡ì€ ì—­í•  ì¤‘ í•œ ëª…ë§Œ ë°œì–¸í•˜ì„¸ìš”. ë‹¤ë¥¸ ì—­í• ì˜ ë°œì–¸ì€ ë‹¤ìŒ ì‚¬ìš©ì ì…ë ¥ í›„ ì´ì–´ì§€ë©´ ë©ë‹ˆë‹¤.
ë‹µë³€ í˜•ì‹ ì˜ˆì‹œëŠ” ë‹¤ìŒê³¼ ê°™ì•„:
{"".join([f"{r}: ...\n" for r in ai_roles])}
""".strip()

    # ì‚¬ìš©ìì—ê²Œ ì˜ˆì‹œ ê°€ì´ë“œë¥¼ ì œê³µí• ì§€ ì—¬ë¶€
    if is_first_time:
        base_prompt += "\nê·¸ë¦¬ê³  ì‚¬ìš©ìì—ê²ŒëŠ” ë‹¤ìŒ ë°œì–¸ ì˜ˆì‹œë¥¼ ê°„ë‹¨íˆ í•œë‘ ì¤„ ì •ë„ë¡œ ì œì‹œí•´. ë„ˆë¬´ ì§€ì‹œí•˜ê±°ë‚˜ ëª…ë ¹ì¡°ë¡œ ë§í•˜ì§€ ë§ˆ."

    return base_prompt.strip()

# ì‚¬ìš©ì ì—­í• ì— ë§ëŠ” ì§ˆë¬¸ ì˜ˆì‹œ 3ê°œ ìƒì„± (ê²€ì‚¬ ë˜ëŠ” ë³€í˜¸ì‚¬ìš©)
def generate_guide_questions(case_facts, user_role, current_phase):
    ensure_model()
    if client is None:
        return "ì˜ˆì‹œ ì§ˆë¬¸ ìƒì„± ì‹¤íŒ¨ (Gemini í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨)"

    prompt = f"""
ë„ˆëŠ” ëª¨ì˜ì¬íŒ ì‹œë®¬ë ˆì´ì…˜ì—ì„œ '{user_role}' ì—­í• ì„ ë§¡ì€ ì‚¬ìš©ìì—ê²Œ ë„ì›€ë§ì„ ì œê³µí•´ì•¼ í•´.
ë‹¤ìŒ ì‚¬ê±´ ì •ë³´ ë˜ëŠ” ë²•ë¥  ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ, '{user_role}'ê°€ ì§ˆë¬¸í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì´ê³  ì‚¬ì‹¤ ê¸°ë°˜ì˜ ì˜ˆì‹œ ì§ˆë¬¸ 3ê°€ì§€ë¥¼ ë§Œë“¤ì–´ì¤˜.
í˜•ë²•, í˜•ì‚¬ì†Œì†¡ë²• ê´€ë ¨ ì‚¬ê±´ì´ë©´ ì¡°ë¬¸, íŒë¡€, ê³ ì˜ì„±, ì±…ì„ ì¡°ê° ì‚¬ìœ  ë“±ì„ ë°˜ì˜í•´ì¤˜.
í˜„ì¬ ë°œì–¸ ë‹¨ê³„ëŠ” '{current_phase}'ì•¼. ì´ ë‹¨ê³„ì— ë§ëŠ” ì§ˆë¬¸ì„ ë§Œë“¤ì–´ì¤˜.

ì‚¬ê±´ ì •ë³´:
{case_facts}

ì¶œë ¥ í˜•ì‹:
- ì˜ˆì‹œ ì§ˆë¬¸ 1:
- ì˜ˆì‹œ ì§ˆë¬¸ 2:
- ì˜ˆì‹œ ì§ˆë¬¸ 3:
""".strip()

    try:
        response = client.send_message(prompt)
        return response.text.strip()
    except Exception as e:
        print("ë„ì›€ë§ ì§ˆë¬¸ ìƒì„± ì˜¤ë¥˜:", e)
        return "ì˜ˆì‹œ ì§ˆë¬¸ ìƒì„± ì‹¤íŒ¨ (AI ì˜¤ë¥˜ ë°œìƒ)"

def generate_judge_opening(case_name, case_facts):
    ensure_model()
    
    prompt = f"""
    ë„ˆëŠ” ë²•ì • ëª¨ì˜ì¬íŒì˜ íŒì‚¬ ì—­í• ì„ ë§¡ì•˜ì–´.
    ì‚¬ê±´ëª…ì€ '{case_name}'ì´ê³ , ì•„ë˜ ì‚¬ê±´ ì •ë³´ë¥¼ ì°¸ê³ í•˜ì—¬ ì¬íŒ ê°œì‹œ ë° ì ˆì°¨ ì•ˆë‚´ ë°œì–¸ë¬¸ì„ ì‘ì„±í•´ì¤˜.
    - ê°„ê²°í•˜ê³  ê³µì‹ì ì¸ ë§íˆ¬ë¡œ ì‘ì„±í•  ê²ƒ.
    - ê²€ì‚¬ì™€ ë³€í˜¸ì¸ì´ ê°ê° ì…ì¥ì„ ì§„ìˆ í•˜ë„ë¡ ì°¨ë¡€ë¥¼ ì•ˆë‚´í•  ê²ƒ.

    ì‚¬ê±´ ì •ë³´:
    {case_facts}

    íŒì‚¬ ë°œì–¸ ì˜ˆì‹œ:
    """
    try:
        response = model.generate_content(prompt)
        text = response.text.strip()
        if not text.startswith("íŒì‚¬:"):
            text = "íŒì‚¬: " + text
        return text
    except Exception as e:
        print("íŒì‚¬ ë°œì–¸ ìƒì„± ì˜¤ë¥˜:", e)
        # ì‹¤íŒ¨ ì‹œ ê°„ë‹¨í•œ ê¸°ë³¸ë¬¸ ë°˜í™˜
        def generate_judge_opening(case_name):
            return f"""íŒì‚¬: ## ë²•ì • ëª¨ì˜ì¬íŒ ê°œì‹œ ë° ì ˆì°¨ ì•ˆë‚´
**ì‚¬ê±´ëª…: {case_name}**
**ì¬íŒì¥: ** (ë•…, ë•…, ë•…)
**ì¬íŒì¥: ** ì§€ê¸ˆë¶€í„° {case_name}ì— ëŒ€í•œ ì¬íŒì„ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.
**ì¬íŒì¥: ** ê²€ì‚¬ ì¸¡ì€ ì‚¬ê±´ ê°œìš” ë° ê³µì†Œ ì‚¬ì‹¤ì— ëŒ€í•œ ì§„ìˆ ì„ ì‹œì‘í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤."""


# ê²€ì‚¬ ë˜ëŠ” ë³€í˜¸ì‚¬ ì—­í• ì˜ ì„œë¡  ë°œì–¸ë¬¸ ìƒì„±
def generate_opening_statement(case_facts, user_role):
    global LAW_KNOWLEDGE
    ensure_model()

    # íŒì‚¬ ë°œì–¸ë¬¸ë„ ì¶”ê°€
    if user_role == "íŒì‚¬":
        prompt = f"""
ë„ˆëŠ” 'íŒì‚¬' ì—­í• ë¡œ ì¬íŒ ê°œì‹œë¥¼ ì•Œë¦¬ê³  ì¬íŒ ì ˆì°¨ë¥¼ ì•ˆë‚´í•˜ëŠ” ê°„ê²°í•œ ë°œì–¸ë¬¸ì„ ì‘ì„±í•´ì•¼ í•´.
- ê³µì†í•˜ê³  ê³µì‹ì ì¸ ë§íˆ¬ë¡œ 3~4ë¬¸ì¥ ì •ë„ ì‘ì„±í•´ì¤˜.

ì‚¬ê±´ ì •ë³´:
{case_facts}
""".strip()
        try:
            response = model.generate_content(prompt)
            return f"{user_role}: {response.text.strip()}"
        except Exception as e:
            print("íŒì‚¬ ë°œì–¸ë¬¸ ìƒì„± ì˜¤ë¥˜:", e)
            return f"{user_role}: (ë°œì–¸ë¬¸ ìƒì„± ì‹¤íŒ¨)"

    # ê²€ì‚¬/ë³€í˜¸ì‚¬ ì—­í• 
    if user_role not in ["ê²€ì‚¬", "ë³€í˜¸ì‚¬"]:
        return ""

    related_laws = find_related_laws(case_facts, LAW_KNOWLEDGE)

    # ê´€ë ¨ ë²•ë¥  ìˆì„ ê²½ìš° ë¯¸ë¦¬ ì •í•´ë‘” ë©˜íŠ¸ ë°˜í™˜
    if related_laws:
        if user_role == "ê²€ì‚¬":
            return "ê²€ì‚¬: í”¼ê³ ì¸ì˜ í–‰ìœ„ëŠ” í˜•ë²•ìƒ ëª…ë°±íˆ ìœ„ë²•í•˜ë©°, ê³ ì˜ì„±ì´ ì…ì¦ëœë‹¤ê³  íŒë‹¨ë©ë‹ˆë‹¤."
        elif user_role == "ë³€í˜¸ì‚¬":
            return "ë³€í˜¸ì‚¬: í”¼ê³ ì¸ì˜ í–‰ìœ„ëŠ” ì •ë‹¹ë°©ìœ„ ë˜ëŠ” ê³¼ì‰ë°©ìœ„ì— í•´ë‹¹í•˜ì—¬ ì±…ì„ì„ ë¬»ê¸° ì–´ë µìŠµë‹ˆë‹¤."

    # AI ìƒì„± í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    statement_type = "ê³µì†Œì‚¬ì‹¤ ì§„ìˆ " if user_role == "ê²€ì‚¬" else "ë³€ë¡  ìš”ì§€ ì§„ìˆ "
    prompt = f"""
ë„ˆëŠ” '{user_role}' ì—­í• ë¡œ '{statement_type}'ì„ ì‘ì„±í•´ì•¼ í•´.
ë‹¤ìŒ ì‚¬ê±´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ '{user_role}'ì˜ ì…ì¥ì—ì„œ ê°„ê²°í•œ ì„œë¡  ë°œì–¸ë¬¸ì„ ì‘ì„±í•´ì¤˜.
- ë¬¸ì¥ì€ 4~5ë¬¸ì¥ ì •ë„ë¡œ í•˜ê³ , ë‚´ìš©ì€ ë°˜ë“œì‹œ ì‚¬ì‹¤ ê¸°ë°˜ì´ì–´ì•¼ í•´.
- ë‹¨ì •ì ì¸ ë§íˆ¬ë¥¼ ì‚¬ìš©í•´.
- 'ì €ëŠ” ê²€ì‚¬ì…ë‹ˆë‹¤' ê°™ì€ ì†Œê°œëŠ” í•˜ì§€ ë§ê³  ë°”ë¡œ ë‚´ìš©ë§Œ ë§í•´ì¤˜.

ì‚¬ê±´ ì •ë³´:
{case_facts}
""".strip()

    try:
        response = model.generate_content(prompt)
        return f"{user_role}: {response.text.strip()}"
    except Exception as e:
        print("ë°œì–¸ë¬¸ ìƒì„± ì˜¤ë¥˜:", e)
        return f"{user_role}: (ë°œì–¸ë¬¸ ìƒì„± ì‹¤íŒ¨)"

# ì‚¬ìš©ìì˜ ëŒ€í™” ì…ë ¥ì„ ê¸°ë°˜ìœ¼ë¡œ Gemini ëª¨ë¸ ì‘ë‹µ ìƒì„±
def generate_response(session_id, user_input):
    if session_id not in conversations:
        conversations[session_id] = []

    conversations[session_id].append(Content(role="user", parts=[Part(text=user_input)]))

    # system ë©”ì‹œì§€ëŠ” ìµœì´ˆ 1íšŒë§Œ ì‚½ì…
    if not any(c.role == "system" for c in conversations[session_id]):
        system_prompt = (
            f"ë‹¹ì‹ ì€ ëª¨ì˜ì¬íŒ ì‹œë®¬ë ˆì´í„°ì˜ AI íŒì‚¬, ê²€ì‚¬, ë³€í˜¸ì‚¬ ì—­í• ì„ ë§¡ê³  ìˆìŠµë‹ˆë‹¤.\n"
            f"ë‹¤ìŒì€ ì°¸ê³ í•´ì•¼ í•  í˜•ë²• ë° í˜•ì‚¬ì†Œì†¡ë²• ì¡°ë¬¸ì…ë‹ˆë‹¤:\n{LAW_KNOWLEDGE}\n"
            f"í˜„ì¬ê¹Œì§€ì˜ ëŒ€í™” ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì—ê²Œ ë²•ì ìœ¼ë¡œ íƒ€ë‹¹í•œ ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”."
        )
        conversations[session_id].insert(0, Content(role="system", parts=[Part(text=system_prompt)]))

    try:
        response = genai.chat(
            model="gemini-2.0-flash-lite",
            messages=conversations[session_id]
        )
        reply_text = response.last.text

        # ì‘ë‹µ ì €ì¥
        conversations[session_id].append(Content(role="model", parts=[Part(text=reply_text)]))
        return reply_text
    except Exception as e:
        print("AI ì‘ë‹µ ìƒì„± ì‹¤íŒ¨:", e)
        return "(AI ì‘ë‹µ ìƒì„± ì‹¤íŒ¨)"

# ì—­í• -ë‹¨ê³„ë³„ ì˜ˆì‹œ ìƒì„± (ì˜ˆ: ê²€ì‚¬ì˜ ì¦ì¸ì‹ ë¬¸ ì˜ˆì‹œ)
def generate_role_phase_example(case_name, role, phase):
    # 1) ì‚¬ê±´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    if case_name in LAW_KNOWLEDGE:
        case_facts = LAW_KNOWLEDGE[case_name]
    else:
        case = CASE_DATABASE.get(case_name)
        if not case:
            return f"'{case_name}' ì‚¬ê±´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        case_facts = case  # JSON ë¬¸ìì—´ì´ ì•„ë‹ˆë¼ dict ê·¸ëŒ€ë¡œ ì „ë‹¬

    # 2) build_prompt_for_role ë‚´ë¶€ì—ì„œ ë¬¸ìì—´í™” í•˜ë„ë¡ ë³€ê²½í•˜ê±°ë‚˜
    #    ë¬¸ìì—´ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ ë³€í™˜í•´ë„ ë¨
    if isinstance(case_facts, dict):
        # ë¬¸ìì—´ë¡œ ë³€í™˜ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ
        case_facts_str = json.dumps(case_facts, ensure_ascii=False, indent=2)
    else:
        case_facts_str = str(case_facts)

    prompt = build_prompt_for_role(role, phase, case_facts_str)

    # 3) AI í˜¸ì¶œ
    try:
        response = client.generate_content(
            model="gemini-2.0-flash-lite",
            contents=[Content(role="user", parts=[Part(text=prompt)])]
        )
        return response.text.strip()
    except Exception as e:
        print("ì—­í• -ë‹¨ê³„ë³„ ì˜ˆì‹œ ìƒì„± ì˜¤ë¥˜:", e)
        import traceback
        traceback.print_exc()
        return "ì—­í• -ë‹¨ê³„ë³„ ì˜ˆì‹œ ìƒì„± ì‹¤íŒ¨ (AI ì˜¤ë¥˜)"

def detect_phase_end(message):
    """í˜„ì¬ ë°œì–¸ì´ phase ì¢…ë£Œë¥¼ ì•”ì‹œí•˜ëŠ”ì§€ ê°„ë‹¨íˆ ë¶„ì„ (ì˜ˆ: 'ì´ìƒì…ë‹ˆë‹¤', 'ì§ˆë¬¸ ë')"""
    triggers = ["ì´ìƒì…ë‹ˆë‹¤", "ì§ˆë¬¸ ë", "ì—¬ê¸°ê¹Œì§€ì…ë‹ˆë‹¤", "ë” ì´ìƒ ì—†ìŠµë‹ˆë‹¤"]
    return any(trigger in message for trigger in triggers)


def get_next_phase(current_phase):
    """í˜„ì¬ phase ë‹¤ìŒ ë‹¨ê³„ ë°˜í™˜"""
    phase_order = ["ì„œë¡ ", "ì¦ê±° ì œì¶œ", "ì¦ì¸ ì‹¬ë¬¸", "ìµœì¢… ë³€ë¡ ", "íŒê²°"]
    try:
        index = phase_order.index(current_phase)
        return phase_order[index + 1] if index + 1 < len(phase_order) else None
    except ValueError:
        return None

# ì¬íŒ ì„¸ì…˜ ì‹œì‘ ë° ì´ˆê¸° í”„ë¡¬í”„íŠ¸, ì˜ˆì‹œ ì œê³µ
@app.route("/start-trial", methods=["POST"])
def start_trial():
    data = request.get_json()
    session_id = data.get("sessionId")
    case_name = data.get("caseName")
    role = data.get("role")
    current_phase = data.get("currentPhase", "ì„œë¡ ")  # ğŸ”§ ê¸°ë³¸ê°’ ì§€ì •

    try:
        ensure_model()

        case_data = CASE_DATABASE.get(case_name)
        if not case_data:
            return jsonify({"error": "í•´ë‹¹ ì‚¬ê±´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 400

        case_facts = case_data.get("facts", "")

        # 1. íŒì‚¬ ë°œì–¸
        judge_opening = generate_judge_opening(case_name, case_facts)

        # 2. ìƒëŒ€ ì—­í•  ì§€ì •
        ai_role = "ë³€í˜¸ì‚¬" if role == "ê²€ì‚¬" else "ê²€ì‚¬"

        # 3. ìƒëŒ€ ì—­í• ì˜ ë°œì–¸ ìƒì„±
        opponent_opening = generate_opening_statement(case_facts, ai_role)

        # 4. ì‚¬ìš©ì ê°€ì´ë“œ ë©”ì‹œì§€ ìƒì„± (ìˆ˜ì •ë¨!)
        guide_message = generate_guide_questions(case_name, role, current_phase)

        # 5. ì „ì²´ ì‘ë‹µ êµ¬ì„±
        if role == "ê²€ì‚¬":
            answer = f"{judge_opening}"  # ê²€ì‚¬ ì°¨ë¡€ë‹ˆê¹Œ íŒì‚¬ ë°œì–¸ê¹Œì§€ë§Œ
        elif role == "ë³€í˜¸ì‚¬":
            answer = f"{judge_opening}\n{opponent_opening}"  # ë³€í˜¸ì‚¬ ì°¨ë¡€ë©´ ê²€ì‚¬ ë°œì–¸ê¹Œì§€ ì¶œë ¥

        return jsonify({
            "answer": answer,
            "guideMessage": guide_message
        })

    except Exception as e:
        print("âŒ [start-trial ì˜ˆì™¸ ë°œìƒ]", e)
        return jsonify({"error": "ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ ë°œìƒ"}), 500

@app.route('/ask-ai', methods=['POST'])
def ask_ai():
    try:
        print("ğŸ“Œ [1] ìš”ì²­ ìˆ˜ì‹ ë¨")
        data = request.get_json()
        print("ğŸ“Œ [2] ìš”ì²­ ë°ì´í„°:", data)

        session_id = data.get('sessionId')
        user_input = data.get('message')
        user_role = data.get('role')
        case_name = data.get('caseName')

        if not all([session_id, user_input, user_role, case_name]):
            return jsonify({'error': 'í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½'}), 400

        case_data = CASE_DATABASE.get(case_name)
        if not case_data:
            return jsonify({'error': f"í•´ë‹¹ ì‚¬ê±´ '{case_name}' ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."}), 404

        case_facts = case_data.get("facts", "")
        if not case_facts:
            return jsonify({'error': f"'{case_name}'ì˜ ì‚¬ê±´ ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."}), 500

        # ì„¸ì…˜ ì´ˆê¸°í™”
        if session_id not in conversations:
            conversations[session_id] = {
                "caseName": case_name,
                "role": user_role,
                "phase": "ì„œë¡ ",
                "history": []
            }

        # ëŒ€í™” ê¸°ë¡ì— ì‚¬ìš©ì ë°œì–¸ ì¶”ê°€
        conversations[session_id]["history"].append({
            "role": user_role,
            "content": user_input
        })

        history = conversations[session_id]["history"]
        messages = [
            {"role": "user" if m["role"] == user_role else "model", "parts": [m["content"]]}
            for m in history
        ]

        ensure_model()

        if model is None:
            return jsonify({'error': 'Gemini ëª¨ë¸ ì´ˆê¸°í™” ì‹¤íŒ¨'}), 500

        chat = model.start_chat()
        response = chat.send_message(messages)

        ai_reply = response.text.strip()

        conversations[session_id]["history"].append({
            "role": "AI",
            "content": ai_reply
        })

        return jsonify({'response': ai_reply})

    except Exception as e:
        print("âŒ [ì˜ˆì™¸ ë°œìƒ] AI ì‘ë‹µ ì˜¤ë¥˜:", e)
        traceback.print_exc()
        return jsonify({'error': 'AI ì‘ë‹µ ìƒì„± ì‹¤íŒ¨'}), 500
    
# ì—­í• /ë‹¨ê³„ ê¸°ë°˜ ì˜ˆì‹œ ë¬¸ì¥ ìš”ì²­
@app.route('/get-role-phase-example', methods=['POST'])
def get_role_phase_example():
    data = request.json
    role = data.get("role")
    phase = data.get("phase")
    case_name = data.get("caseName")

    if not role or not phase or not case_name:
        return jsonify({"error": "role, phase, caseName í•„ìˆ˜"}), 400

    example_text = generate_role_phase_example(case_name, role, phase)

    return jsonify({
        "role": role,
        "phase": phase,
        "example": example_text
    })

# ì„œë²„ ì‹¤í–‰
if __name__ == '__main__':
    load_case_database()
    app.run(debug=True)
