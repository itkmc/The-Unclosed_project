import os
from flask import Flask, request, jsonify
import google.generativeai as genai
import importlib.util
import traceback
from api_test import get_statute_json ,parse_statutes, get_case_list, get_case_detail
from promt_respose import build_prompt_for_role, build_case_summary, infer_target_role_from_question, format_statutes_for_prompt, format_precedents_for_prompt, determine_speaker_for_phase

# Google GenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” (Gemini API ì‚¬ìš©)
client = genai.configure(api_key="")

# ì „ì—­ client ê°ì²´
model = None
client = None
conversations = {}
_cached_legal_data_map = {}

def ensure_model():
    global model, client
    if model is None:
        try:
            model = genai.GenerativeModel("gemini-2.0-flash-lite")
        except Exception as e:
            print("Gemini ëª¨ë¸ ì´ˆê¸°í™” ì‹¤íŒ¨:", e)
            model = None
            return
    if client is None and model is not None:
        try:
            client = model.start_chat(history=[])
        except Exception as e:
            print("Gemini ì±„íŒ… ì„¸ì…˜ ì‹œì‘ ì‹¤íŒ¨:", e)
            client = None

app = Flask(__name__)

# /data í´ë”ì— ìˆëŠ” ì‚¬ê±´ ì •ë³´ë¥¼ ë‹´ì€ .py íŒŒì¼ë“¤ì„ ë™ì ìœ¼ë¡œ ë¶ˆëŸ¬ì™€ ë”•ì…”ë„ˆë¦¬ í˜•íƒœë¡œ ë°˜í™˜
def load_case_database():
    # ì‚¬ê±´ ë°ì´í„°ë¥¼ ì €ì¥í•  ë”•ì…”ë„ˆë¦¬ (caseNameì„ keyë¡œ, ì‚¬ê±´ ì „ì²´ ì •ë³´ë¥¼ valueë¡œ ì €ì¥)
    CASE_DATABASE = {}

    # í˜„ì¬ íŒŒì¼ì´ ìœ„ì¹˜í•œ ê²½ë¡œë¥¼ ê¸°ì¤€ìœ¼ë¡œ data ë””ë ‰í† ë¦¬ì˜ ì „ì²´ ê²½ë¡œë¥¼ ìƒì„±
    data_dir = os.path.join(os.path.dirname(__file__), "data")

    # data ë””ë ‰í† ë¦¬ì— ìˆëŠ” ëª¨ë“  íŒŒì¼ì„ ìˆœíšŒ
    for filename in os.listdir(data_dir):
        # .py í™•ì¥ìë¥¼ ê°€ì§„ íŒŒì´ì¬ íŒŒì¼ë§Œ ì²˜ë¦¬
        if filename.endswith(".py"):
            # íŒŒì¼ì˜ ì „ì²´ ê²½ë¡œ ìƒì„±
            filepath = os.path.join(data_dir, filename)

            # í•´ë‹¹ íŒŒì¼ì„ ëª¨ë“ˆë¡œ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•œ spec(ì‚¬ì–‘) ê°ì²´ ìƒì„±
            spec = importlib.util.spec_from_file_location("module.name", filepath)
            
            # specì„ ê¸°ë°˜ìœ¼ë¡œ ì„ì‹œ ëª¨ë“ˆ ê°ì²´ ìƒì„±
            module = importlib.util.module_from_spec(spec)

            # ëª¨ë“ˆ ì‹¤ì œ ë¡œë”© ìˆ˜í–‰ (ì½”ë“œë¥¼ ì‹¤í–‰ì‹œì¼œ ë©”ëª¨ë¦¬ì— ì˜¬ë¦¼)
            spec.loader.exec_module(module)

            # í•´ë‹¹ ëª¨ë“ˆì— 'cases'ë¼ëŠ” ë¦¬ìŠ¤íŠ¸ ë³€ìˆ˜ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if hasattr(module, "cases"):
                # cases ë¦¬ìŠ¤íŠ¸ì— ìˆëŠ” ê° ì‚¬ê±´(case)ì„ ìˆœíšŒ
                for case in module.cases:
                    # ì‚¬ê±´ì˜ ê³ ìœ  ì´ë¦„ì„ keyë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ê°€ì ¸ì˜´
                    case_name = case.get("caseName")
                    
                    # caseNameì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°ë§Œ CASE_DATABASEì— ì¶”ê°€
                    if case_name:
                        CASE_DATABASE[case_name] = case
            else:
                # í•´ë‹¹ ëª¨ë“ˆì— 'cases' ë³€ìˆ˜ê°€ ì—†ëŠ” ê²½ìš° ê²½ê³  ì¶œë ¥
                print(f"[ê²½ê³ ] {filename} ì— 'cases' ë³€ìˆ˜ ì—†ìŒ")

    # ë¡œë”©ì´ ì™„ë£Œëœ ì‚¬ê±´ ëª©ë¡ ì¶œë ¥
    print("í˜„ì¬ ë¡œë“œëœ ì‚¬ê±´ ëª©ë¡:", list(CASE_DATABASE.keys()))

    # ëª¨ë“  ì‚¬ê±´ ë°ì´í„°ë¥¼ í¬í•¨í•œ ë”•ì…”ë„ˆë¦¬ ë°˜í™˜
    return CASE_DATABASE

# ì‚¬ê±´ ì •ë³´ë¥¼ ì €ì¥í•  ì „ì—­ ë”•ì…”ë„ˆë¦¬
CASE_DATABASE = load_case_database()

# âœ… ì‚¬ê±´ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ê´€ë ¨ ë²•ë¥  ë° í‚¤ì›Œë“œ ìë™ ì¶”ë¡ 
def infer_laws_and_keywords_from_case(case):
    import json

    laws = set()
    keywords = set()

    # ğŸ” ì¬ê·€ì ìœ¼ë¡œ ëª¨ë“  ë¬¸ìì—´ ìˆ˜ì§‘
    def extract_texts(obj):
        texts = []
        if isinstance(obj, dict):
            for k, v in obj.items():
                if isinstance(v, (dict, list)):
                    texts.extend(extract_texts(v))
                elif isinstance(v, str):
                    texts.append(v.lower())
        elif isinstance(obj, list):
            for item in obj:
                texts.extend(extract_texts(item))
        return texts

    all_text = " ".join(extract_texts(case))

    # âœ… í‚¤ì›Œë“œ ê·¸ë£¹ ì •ì˜
    keyword_groups = {
        "ì‚´ì¸": ["ì‚´ì¸", "ì‚´í•´", "íƒ€ì‚´", "êµì‚´", "ê²½ë¶€ì••ë°•"],
        "ì„±í­í–‰": ["ì„±í­í–‰", "ì„±ì¶”í–‰", "ê°•ê°„", "ì„±ë²”ì£„", "ì„±í­ë ¥", "ì„±ì "],
        "ì•„ë™í•™ëŒ€": ["ì•„ë™í•™ëŒ€", "ì•„ë™", "í•™ëŒ€", "ìœ ê¸°", "ë°©ì„"],
        "ì‹œì²´ìœ ê¸°": ["ì•”ë§¤ì¥", "ì‹œì²´ìœ ê¸°", "ì‹œì‹  ìœ ê¸°", "ìœ ê¸°"],
        "ì‚¬ë²•ì¡°ì‘": ["ì¡°ì‘", "ì¬ì‹¬", "ë¬´ì£„"],
        "ì—°ì‡„ì‚´ì¸": ["ì—°ì‡„ì‚´ì¸", "ìœ ì‚¬ ì‚¬ê±´"],
        "ì •ì‹ ì§ˆí™˜": ["ì¥ì• ", "ì •ì‹ ë³‘ì", "ì •ì‹ ì´ìƒ"]
    }

    # âœ… í‚¤ì›Œë“œì™€ ë²•ë¥  ì¶”ë¡ 
    for keyword, terms in keyword_groups.items():
        if any(term in all_text for term in terms):
            keywords.add(keyword)
            if keyword in {"ì‚´ì¸", "ì„±í­í–‰"}:
                laws.add("í˜•ë²•")
            elif keyword == "ì•„ë™í•™ëŒ€":
                laws.add("ì•„ë™ë³µì§€ë²•")

    # âœ… ê°œë³„ ì¡°ê±´ ì²˜ë¦¬
    if "ê³µì†Œì‹œíš¨" in all_text:
        laws.add("í˜•ì‚¬ì†Œì†¡ë²•")
        keywords.add("ê³µì†Œì‹œíš¨")

    if "ìœ ì¡±" in all_text:
        keywords.add("ìœ ì¡±")

    # âœ… ë³´ì™„: ì•„ë¬´ê²ƒë„ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’
    if not laws:
        laws.add("í˜•ë²•")
    if not keywords:
        keywords.add("ì‚´ì¸")

    return list(laws), list(keywords)

def update_phase_based_on_question(question, current_phase):
    q = question.strip()

    # ì¬íŒ ì‹œì‘ ê´€ë ¨
    if any(kw in q for kw in ["ì¬íŒ ì‹œì‘", "ê°œì‹œ", "ì‹œì‘"]):
        return "ì„œë¡ "

    # ì¦ì¸ ì‹ ë¬¸ ê´€ë ¨ - ë‹¤ì–‘í•œ í‘œí˜„ ëŒ€ì‘
    if "ì¦ì¸" in q and any(kw in q for kw in ["ì‹œì‘", "ì‹ ë¬¸", "ì§„í–‰", "í•˜ì„¸ìš”", "í•´ì£¼ì„¸ìš”"]):
        return "ì¦ì¸ì‹ ë¬¸"

    # ë°˜ëŒ€ì‹ ë¬¸ ê´€ë ¨ - "ì¦ì¸ ë°˜ëŒ€ì‹ ë¬¸"ë„ í¬í•¨ì‹œí‚¤ê¸° ìœ„í•´ ì¡°ê±´ ë³€ê²½
    if "ë°˜ëŒ€ì‹ ë¬¸" in q:
        return "ë°˜ëŒ€ì‹ ë¬¸"

    # ê³µì†Œ ì‚¬ì‹¤ ì§„ìˆ  ê´€ë ¨ - "ê³µì†Œ"ëŠ” í¬í•¨í•˜ë˜, "ì¦ì¸"ì´ ì—†ì„ ë•Œë¡œ ì œí•œ (ì¦ì¸ì‹ ë¬¸ í˜¼ë™ ë°©ì§€)
    if "ê³µì†Œ" in q or ("ê²€ì‚¬" in q and "ì¦ì¸" not in q):
        return "ê³µì†Œì‚¬ì‹¤"

    # ë³€ë¡  ìš”ì§€ ì§„ìˆ  ê´€ë ¨
    if "ë³€í˜¸ì‚¬" in q or "ë³€ë¡  ìš”ì§€" in q:
        return "ë³€ë¡ ìš”ì§€"

    # ìµœì¢… ì˜ê²¬ ìš”ì²­ ê´€ë ¨
    if any(kw in q for kw in ["ìµœì¢… ì˜ê²¬", "ìµœì¢…ì˜ê²¬"]):
        return "ìµœì¢…ì˜ê²¬ìš”ì²­"

    # ìµœì¢… ë³€ë¡  ê´€ë ¨
    if any(kw in q for kw in ["ìµœì¢… ë³€ë¡ ", "ë§ˆë¬´ë¦¬"]):
        return "ìµœì¢…ë³€ë¡ "

    # íŒê²° ì„ ê³  ê´€ë ¨
    if any(kw in q for kw in ["íŒê²°", "ì„ ê³ "]):
        return "íŒê²°ì„ ê³ "

    # ê³„ì†, ì§„í–‰, ë‹¤ìŒ ë“±ì€ í˜„ì¬ ë‹¨ê³„ ìœ ì§€
    if any(kw in q for kw in ["ê³„ì†", "ì§„í–‰", "ë‹¤ìŒ"]):
        return current_phase

    # ê¸°ë³¸ì ìœ¼ë¡œ í˜„ì¬ ë‹¨ê³„ ìœ ì§€
    return current_phase

def load_legal_knowledge(caseData=None, max_precedents=5):
    """
    ì‚¬ê±´ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê´€ë ¨ ë²•ë¥  ë° íŒë¡€ë¥¼ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜,
    ì‚¬ê±´ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’(í˜•ë²• + ì‚´ì¸ í‚¤ì›Œë“œ)ìœ¼ë¡œ ë¡œë“œí•©ë‹ˆë‹¤.
    """
    legal_data = {
        "statutes": [],
        "precedents": []
    }

    # 1. ì‚¬ê±´ ê¸°ë°˜ í‚¤ì›Œë“œ ì¶”ë¡  ë˜ëŠ” ê¸°ë³¸ê°’ ì„¤ì •
    if caseData:
        laws, keywords = infer_laws_and_keywords_from_case(caseData)
    else:
        laws = ["í˜•ë²•"]
        keywords = ["ì‚´ì¸"]

    # 2. ì¡°ë¬¸ ìˆ˜ì§‘
    for law_name in laws:
        try:
            raw_data = get_statute_json(law_name)
            statutes = parse_statutes(raw_data)
            if statutes:
                legal_data["statutes"].extend(statutes)
        except Exception as e:
            print(f"[ê²½ê³ ] '{law_name}' ì¡°ë¬¸ ë¡œë”© ì‹¤íŒ¨:", e)

    # 3. íŒë¡€ ìˆ˜ì§‘ (ì¤‘ë³µ ì œê±° ë° í•„í„°ë§)
    seen_case_ids = set()
    for keyword in keywords:
        case_list = get_case_list(keyword)
        for case in case_list:
            cid = case["íŒë¡€ì¼ë ¨ë²ˆí˜¸"]
            if cid not in seen_case_ids:
                detail = get_case_detail(cid)
                print("detail type:", type(detail), "detail:", detail)
                if detail and isinstance(detail, dict):
                    íŒê²°ìš”ì§€ = detail.get("íŒê²°ìš”ì§€", "")
                    if íŒê²°ìš”ì§€ and íŒê²°ìš”ì§€.strip():
                        legal_data["precedents"].append(detail)
                        seen_case_ids.add(cid)
            if len(legal_data["precedents"]) >= max_precedents:
                break
        if len(legal_data["precedents"]) >= max_precedents:
            break

    print(f"[ë²•ë¥  ì •ë³´ ë¡œë”©] ì¡°ë¬¸ ìˆ˜: {len(legal_data['statutes'])}, íŒë¡€ ìˆ˜: {len(legal_data['precedents'])}")
    return legal_data

PHASE_FLOW = ["ì„œë¡ ", "ì¦ê±° ì œì¶œ", "ë°˜ë°•", "ìµœì¢… ë³€ë¡ "]

def advance_phase(current_phase, phase_list=PHASE_FLOW):
    try:
        idx = phase_list.index(current_phase)
        return phase_list[idx + 1] if idx + 1 < len(phase_list) else current_phase
    except ValueError:
        return current_phase

def generate_gemini_response(prompt: str) -> str:
    ensure_model()

    if client is None:
        raise RuntimeError("Gemini í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    try:
        response = client.send_message(prompt)

        # ì‘ë‹µ êµ¬ì¡°ê°€ ì—¬ëŸ¬ í›„ë³´(candidates)ë¡œ ì˜¤ëŠ” ê²½ìš° ëŒ€ë¹„
        if hasattr(response, "text") and response.text:
            return response.text.strip()

        elif hasattr(response, "candidates") and response.candidates:
            return "\n".join(
                part.text for part in response.candidates[0].content.parts if hasattr(part, "text")
            ).strip()

        else:
            return "[AI ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤]"

    except Exception as e:
        print("Gemini ì‘ë‹µ ì˜¤ë¥˜:", e)
        return "[Gemini í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ]"

def generate_guide_and_examples_with_ai(user_role, caseData, phase, conversation, legal_data):
    prompt = f"""
ë‹¹ì‹ ì€ '{user_role}' ì—­í• ì„ ë§¡ê³  ìˆìœ¼ë©°, í˜„ì¬ ì¬íŒ ë‹¨ê³„ëŠ” [{phase}]ì…ë‹ˆë‹¤.
í˜„ì¬ ë‹¨ê³„ì— ë§ëŠ” ê°€ì´ë“œ ë©”ì‹œì§€ 1~2ê°œ (ì§ˆë¬¸ ë° ë‹µë³€ ì˜ˆì‹œ í¬í•¨)ì™€ ì‹¤ì œ ì‚¬ê±´ì— ê¸°ë°˜í•œ ì—­í•  ì í•© ì˜ˆì‹œ ì§ˆë¬¸ 3ê°œë¥¼ ì‘ì„±í•˜ì„¸ìš”.

ì‚¬ê±´ ê°œìš”:
{build_case_summary(caseData)}

ê´€ë ¨ ë²•ë¥  ì¡°ë¬¸:
{format_statutes_for_prompt(legal_data['statutes'])}

ì°¸ê³  íŒë¡€:
{format_precedents_for_prompt(legal_data['precedents'])}

ì¶œë ¥ í˜•ì‹:
ê°€ì´ë“œ ë©”ì‹œì§€:
- ì§ˆë¬¸: ...
  ë‹µë³€ ì˜ˆì‹œ: ...
- ì§ˆë¬¸: ...
  ë‹µë³€ ì˜ˆì‹œ: ...

ì˜ˆì‹œ ì§ˆë¬¸:
- ì§ˆë¬¸1
- ì§ˆë¬¸2
- ì§ˆë¬¸3
"""

    try:
        ensure_model()
        result = client.send_message(prompt)
        text = result.text.strip()

        print("[DEBUG] AI ì‘ë‹µ:", repr(text))

        lines = text.splitlines()
        guide_lines = []
        examples = []

        parsing_guide = False
        parsing_examples = False

        for line in lines:
            line = line.strip()
            if line.lower().startswith("ê°€ì´ë“œ ë©”ì‹œì§€"):
                parsing_guide = True
                parsing_examples = False
                continue
            elif line.lower().startswith("ì˜ˆì‹œ ì§ˆë¬¸"):
                parsing_examples = True
                parsing_guide = False
                continue

            if parsing_guide:
                guide_lines.append(line)
            elif parsing_examples:
                if line.startswith("-"):
                    examples.append(line[1:].strip())
                else:
                    parsing_examples = False

        guide = "\n".join(guide_lines).strip()
        if not guide:
            print("[âš ï¸ê²½ê³ ] ê°€ì´ë“œ ë©”ì‹œì§€ íŒŒì‹± ì‹¤íŒ¨. ì „ì²´ ì‘ë‹µ ì¶œë ¥:\n", text)

        return guide, examples

    except Exception as e:
        print("generate_guide_and_examples_with_ai ì˜¤ë¥˜:", e)
        return "", []
    
def generate_initial_role_speech(user_role, caseData, phase):
    case_summary = build_case_summary(caseData)

    prompt = f"""
ë‹¹ì‹ ì€ ì§€ê¸ˆ {user_role} ì—­í• ë¡œ ëª¨ì˜ì¬íŒì— ì°¸ì—¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.
í˜„ì¬ ì¬íŒ ë‹¨ê³„ëŠ” [ì„œë¡ ]ì…ë‹ˆë‹¤.

ì‚¬ê±´ ìš”ì•½:
{case_summary}

ì§€ê¸ˆì€ ì„œë¡  ë‹¨ê³„ì´ë¯€ë¡œ, {user_role}ë¡œì„œ ì•„ë˜ì™€ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì„œë¡  ë°œì–¸ì„ ì‘ì„±í•˜ì„¸ìš”.

â€» í˜•ì‹:
{user_role}: [ì§„ì§€í•˜ê³  êµ¬ì²´ì ì¸ ì„œë¡  ë°œì–¸. ìµœì†Œ 3ë¬¸ì¥ ì´ìƒ. ì£¼ì¥, ë¬¸ì œ ì œê¸°, ìˆ˜ì‚¬ ë°©í–¥, ì¦ê±° í™•ë³´ ì˜ì§€ ë“±ì„ í¬í•¨.]

â€» ì˜¤ì§ {user_role}ì˜ ë°œì–¸ë§Œ ì¶œë ¥í•˜ì„¸ìš”. 'íŒì‚¬:', 'ë³€í˜¸ì‚¬:'ëŠ” ì ˆëŒ€ ì¶œë ¥í•˜ì§€ ë§ˆì„¸ìš”.
""".strip()

    try:
        ensure_model()
        result = client.send_message(prompt)
        return result.text.strip()
    except Exception as e:
        return f"{user_role}: (ì„œë¡  ë°œì–¸ ìƒì„± ì‹¤íŒ¨)"    

@app.route('/start-trial', methods=['POST'])
def start_trial():
    data = request.get_json()
    session_id = data.get("sessionId")
    case_name = data.get("caseName")
    user_role = data.get("userRole")

    caseData = CASE_DATABASE.get(case_name)
    current_phase = "ì„œë¡ "

    global _cached_legal_data
    if _cached_legal_data is None:
        _cached_legal_data = load_legal_knowledge()

    legal_data = _cached_legal_data

    # ì„¸ì…˜ ì´ˆê¸°í™”
    conversations[session_id] = {
        "conversation": [],
        "phase": current_phase,
        "userRole": user_role,
        "caseName": case_name
    }

    case_summary = build_case_summary(caseData)

    judge_prompt = f"""
    ë‹¹ì‹ ì€ 'íŒì‚¬' ì—­í• ì…ë‹ˆë‹¤. ì§€ê¸ˆë¶€í„° '{case_name}' ì‚¬ê±´ì— ëŒ€í•œ ì¬íŒì„ ì‹œì‘í•˜ë ¤ í•©ë‹ˆë‹¤.
    í”¼ê³ ì¸ì˜ í˜ì˜ì™€ í”¼í•´ì ìƒí™©ì— ëŒ€í•´ ê°„ë‹¨íˆ ì–¸ê¸‰í•˜ë©°, ì¬íŒ ê°œì‹œë¥¼ ì•Œë¦¬ëŠ” í¬ë©€í•œ ì²« ë©˜íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.

    - ëŒ€ìƒ ì—­í• : {user_role}
    - ì‚¬ê±´ ìš”ì•½: 
    {case_summary}

    ì¶œë ¥ í˜•ì‹ì€ ë°˜ë“œì‹œ ì•„ë˜ì²˜ëŸ¼ í•˜ì„¸ìš”:
    íŒì‚¬: (3~5ë¬¸ì¥ ë¶„ëŸ‰ìœ¼ë¡œ ì¬íŒ ê°œì‹œ ë©˜íŠ¸, ì‚¬ê±´ëª… ì–¸ê¸‰, ì°¸ì—¬ì ì—­í•  ì–¸ê¸‰)
    """

    try:
        ensure_model()
        result = client.send_message(judge_prompt)
        judge_speech = result.text.strip()

        # âœ… ë§Œì•½ "íŒì‚¬:"ë¡œ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë©´ ê°•ì œë¡œ ë¶™ì´ê¸°
        if not judge_speech.startswith("íŒì‚¬:"):
            judge_speech = "íŒì‚¬: " + judge_speech

    except Exception as e:
        print("íŒì‚¬ ë°œì–¸ ìƒì„± ì˜¤ë¥˜:", e)
        judge_speech = f"íŒì‚¬: ë³¸ ì¬íŒì„ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤. '{case_name}' ì‚¬ê±´ì— ëŒ€í•´ {user_role} ì—­í• ë¡œ ì°¸ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤."

    # ğŸ‘‡ ê°€ì´ë“œ ë©”ì‹œì§€ ìƒì„± (ë¬¸ì œ ì—†ìŒ)
    guide_message, example_questions = generate_guide_and_examples_with_ai(
        user_role, caseData, current_phase, conversations[session_id]["conversation"], legal_data
    )

    return jsonify({
        "answer": judge_speech,
        "guideMessage": guide_message,
        "exampleQuestions": example_questions,
        "nextPhase": current_phase
    })

_cached_legal_data = None

@app.route("/ask-ai", methods=["POST"])
def ask_ai():
    data = request.get_json()
    session_id = data.get("sessionId")
    question = data.get("question", "").strip()
    user_role = data.get("userRole")
    case_name = data.get("caseName")

    if not all([session_id, question, user_role, case_name]):
        return jsonify({"error": "í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½"}), 400

    # ì„¸ì…˜ ë¶ˆëŸ¬ì˜¤ê¸° ë˜ëŠ” ì´ˆê¸°í™”
    session_data = conversations.get(session_id)
    if not session_data:
        conversations[session_id] = {
            "caseName": case_name,
            "userRole": user_role,
            "phase": "ì„œë¡ ",
            "conversation": []
        }
    session_data = conversations[session_id]

    caseData = CASE_DATABASE.get(case_name)
    if not caseData:
        return jsonify({"error": "í•´ë‹¹ ì‚¬ê±´ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 404

    current_phase = session_data.get("phase", "ì„œë¡ ")

    # ë‹¨ê³„ ì—…ë°ì´íŠ¸
    new_phase = update_phase_based_on_question(question, current_phase)
    session_data["phase"] = new_phase

    # ëŒ€í™” ì €ì¥
    session_data["conversation"].append(f"{user_role}: {question}")

    # ë²•ë¥  ì§€ì‹ ë¶ˆëŸ¬ì˜¤ê¸°
    global _cached_legal_data_map
    if case_name not in _cached_legal_data_map:
        _cached_legal_data_map[case_name] = load_legal_knowledge(caseData)
    legal_data = _cached_legal_data_map[case_name]

    # í˜„ì¬ ìƒí™©ì—ì„œ AIê°€ ì–´ë–¤ ì—­í• ì„ ë§í•´ì•¼ í•˜ëŠ”ì§€ ì¶”ë¡ 
    target_role = infer_target_role_from_question(question, new_phase, user_role)

    # ì¶”ë¡  ì‹¤íŒ¨ ì‹œ, phase ê¸°ì¤€ìœ¼ë¡œ fallback ì²˜ë¦¬
    if not target_role:
        target_role = determine_speaker_for_phase(user_role, new_phase, strict=True)

    # í”„ë¡¬í”„íŠ¸ ìƒì„± ë° AI ì‘ë‹µ
    prompt = build_prompt_for_role(case_name, target_role, legal_data, question, caseData, phase=new_phase)
    ai_response = generate_gemini_response(prompt)

    # ì—­í•  í•„í„°ë§
    lines = ai_response.strip().splitlines()
    start_idx = next((i for i, l in enumerate(lines) if l.strip().startswith(f"{target_role}:")), None)
    filtered_response = "\n".join(lines[start_idx:]).strip() if start_idx is not None else ai_response.strip()

    # ê²€ì‚¬ ì§ˆë¬¸ â†’ ì¦ì¸ ì‘ë‹µ ìë™ ìƒì„± ì¡°ê±´ í™•ì¸
    should_generate_witness = (
        target_role == "ê²€ì‚¬" and
        new_phase == "ì¦ì¸ì‹ ë¬¸" and
        "?" in filtered_response
    )

    witness_answer = ""
    if should_generate_witness:
        witness_prompt = f"""ë‹¹ì‹ ì€ ë²•ì • ì¦ì¸ì…ë‹ˆë‹¤.
ê²€ì‚¬ë¡œë¶€í„° ë‹¤ìŒ ì§ˆë¬¸ì„ ë°›ì•˜ìŠµë‹ˆë‹¤:

'''{filtered_response}'''

ì‚¬ì‹¤ì— ê¸°ë°˜í•œ ì§„ì†”í•˜ê³  êµ¬ì²´ì ì¸ ë‹µë³€ì„ ì‘ì„±í•˜ì„¸ìš”.
ë‹µë³€ì€ ë°˜ë“œì‹œ 'ì¦ì¸:'ìœ¼ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.
"""
        try:
            witness_raw = generate_gemini_response(witness_prompt)
            lines = witness_raw.strip().splitlines()
            witness_idx = next((i for i, l in enumerate(lines) if l.strip().startswith("ì¦ì¸:")), None)
            witness_answer = "\n".join(lines[witness_idx:]).strip() if witness_idx is not None else witness_raw.strip()
        except Exception as e:
            print("[âŒ ì¦ì¸ ì‘ë‹µ ìƒì„± ì‹¤íŒ¨]", e)

    # ê°€ì´ë“œ ë©”ì‹œì§€ ë° ì˜ˆì‹œ ì§ˆë¬¸ ìƒì„±
    try:
        guide_message, example_questions = generate_guide_and_examples_with_ai(
            user_role, caseData, new_phase, session_data["conversation"], legal_data
        )
    except Exception as e:
        import traceback
        traceback.print_exc()
        guide_message = ""
        example_questions = []

    return jsonify({
        "answer": filtered_response,
        "witnessAnswer": witness_answer,
        "guideMessage": guide_message,
        "exampleQuestions": example_questions,
        "nextPhase": new_phase,
        "currentPhase": new_phase
    })

if __name__ == '__main__':
    app.run(debug=True)